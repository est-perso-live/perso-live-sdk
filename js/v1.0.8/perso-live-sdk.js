var PersoLiveSDK=function(){"use strict";function t(){}function e(t){return t()}function s(){return Object.create(null)}function a(t){t.forEach(e)}function n(t){return"function"==typeof t}function r(t,e){return t!=t?e==e:t!==e||t&&"object"==typeof t||"function"==typeof t}function i(t){t.parentNode&&t.parentNode.removeChild(t)}let o;function c(t){o=t}const h=[],d=[];let l=[];const u=[],g=Promise.resolve();let p=!1;function f(t){l.push(t)}const m=new Set;let v=0;function y(){if(0!==v)return;const t=o;do{try{for(;v<h.length;){const t=h[v];v++,c(t),w(t.$$)}}catch(t){throw h.length=0,v=0,t}for(c(null),h.length=0,v=0;d.length;)d.pop()();for(let t=0;t<l.length;t+=1){const e=l[t];m.has(e)||(m.add(e),e())}l.length=0}while(h.length);for(;u.length;)u.pop()();p=!1,m.clear(),c(t)}function w(t){if(null!==t.fragment){t.update(),a(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(f)}}const S=new Set;function $(t,e){const s=t.$$;null!==s.fragment&&(!function(t){const e=[],s=[];l.forEach((a=>-1===t.indexOf(a)?e.push(a):s.push(a))),s.forEach((t=>t())),l=e}(s.after_update),a(s.on_destroy),s.fragment&&s.fragment.d(e),s.on_destroy=s.fragment=null,s.ctx=[])}function E(t,e){-1===t.$$.dirty[0]&&(h.push(t),p||(p=!0,g.then(y)),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function C(r,h,d,l,u,g,p,m=[-1]){const v=o;c(r);const w=r.$$={fragment:null,ctx:[],props:g,update:t,not_equal:u,bound:s(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(h.context||(v?v.$$.context:[])),callbacks:s(),dirty:m,skip_bound:!1,root:h.target||v.$$.root};p&&p(w.root);let $=!1;if(w.ctx=d?d(r,h.props||{},((t,e,...s)=>{const a=s.length?s[0]:e;return w.ctx&&u(w.ctx[t],w.ctx[t]=a)&&(!w.skip_bound&&w.bound[t]&&w.bound[t](a),$&&E(r,t)),e})):[],w.update(),$=!0,a(w.before_update),w.fragment=!!l&&l(w.ctx),h.target){if(h.hydrate){const t=(T=h.target,Array.from(T.childNodes));w.fragment&&w.fragment.l(t),t.forEach(i)}else w.fragment&&w.fragment.c();h.intro&&((C=r.$$.fragment)&&C.i&&(S.delete(C),C.i(L))),function(t,s,r,i){const{fragment:o,after_update:c}=t.$$;o&&o.m(s,r),i||f((()=>{const s=t.$$.on_mount.map(e).filter(n);t.$$.on_destroy?t.$$.on_destroy.push(...s):a(s),t.$$.on_mount=[]})),c.forEach(f)}(r,h.target,h.anchor,h.customElement),y()}var C,L,T;c(v)}class L{$destroy(){$(this,1),this.$destroy=t}$on(e,s){if(!n(s))return t;const a=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return a.push(s),()=>{const t=a.indexOf(s);-1!==t&&a.splice(t,1)}}$set(t){var e;this.$$set&&(e=t,0!==Object.keys(e).length)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}function T(t,e,s,a){if("a"===s&&!a)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!a:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?a:"a"===s?a.call(t):a?a.value:e.get(t)}"function"==typeof SuppressedError&&SuppressedError;class b extends Error{constructor(){super("WebRTC connection timeout")}}class _ extends Error{constructor(t,e,s,a){let n;n=null!=a?`${t}:${a}_${s}`:`${t}:${s}`,super(n),this.errorCode=t,this.code=e,this.detail=s,this.attr=a}}class I{static async getLLMs(t,e){const s=fetch(`${t}/api/v1/settings/llm_type/`,{headers:{"PersoLive-APIKey":e},method:"GET"}),a=await s;return await this.parseJson(a)}static async getModelStyles(t,e){const s=fetch(`${t}/api/v1/settings/modelstyle/`,{headers:{"PersoLive-APIKey":e},method:"GET"}),a=await s;return await this.parseJson(a)}static async getBackgroundImages(t,e){const s=fetch(`${t}/api/v1/background_image/`,{headers:{"PersoLive-APIKey":e},method:"GET"}),a=await s;return await this.parseJson(a)}static async getTTSs(t,e){const s=fetch(`${t}/api/v1/settings/tts_type/`,{headers:{"PersoLive-APIKey":e},method:"GET"}),a=await s;return await this.parseJson(a)}static async getPrompts(t,e){const s=fetch(`${t}/api/v1/prompt/`,{headers:{"PersoLive-APIKey":e},method:"GET"}),a=await s;return await this.parseJson(a)}static async getDocuments(t,e){const s=fetch(`${t}/api/v1/document/`,{headers:{"PersoLive-APIKey":e},method:"GET"}),a=await s;return await this.parseJson(a)}static async getSessionInfo(t,e){const s=fetch(`${t}/api/v1/session/${e}/`,{method:"GET"}),a=await s;return await this.parseJson(a)}static async parseJson(t){const e=await t.json();if(t.ok)return e;throw new _(t.status,e.errors[0].code,e.errors[0].detail,e.errors[0].attr)}}var M,x;class k extends EventTarget{static async createSessionId(t,e,s,a,n,r,i,o,c,h,d){const l=await fetch(`${t}/api/v1/session/`,{body:JSON.stringify({llm_type:s,tts_type:a,model_style:n,prompt:r,document:i,background_image:o,padding_left:c,padding_top:h,padding_height:d}),headers:{"PersoLive-APIKey":e,"Content-Type":"application/json"},method:"POST"});return(await I.parseJson(l)).session_id}static async create(t,e,s,a,n){const r=await fetch(`${t}/api/v1/session/${e}/ice-servers/`,{method:"GET"}),i=(await I.parseJson(r)).ice_servers;let o=await k.createPeerConnection(i),c=o.createDataChannel("message",{protocol:"message"}),h=new k(o,c);s.getTracks().forEach((function(t){o.addTrack(t,s)}));const d=o.addTransceiver("video",{direction:"recvonly"}),l=RTCRtpReceiver.getCapabilities("video");null!=l&&d.setCodecPreferences(l.codecs.filter((t=>"video/VP8"===t.mimeType)));const u=await o.createOffer();await o.setLocalDescription(u);const g=await fetch(`${t}/api/v1/session/${e}/exchange/`,{body:JSON.stringify({client_sdp:u}),headers:{"Content-Type":"application/json"},method:"POST"}),p=await I.parseJson(g);return await o.setRemoteDescription(p.server_sdp),await k.waitFor((()=>h.isReady()),100,50),h.changeSize(a,n),h}static async createPeerConnection(t){return new RTCPeerConnection({sdpSemantics:"unified-plan",iceServers:t})}static async waitFor(t,e,s){let a=0;if(await new Promise((n=>{const r=setInterval((()=>{a+=1,a>=s&&(clearInterval(r),n("bad")),t()&&(clearInterval(r),n("good"))}),e)})),a>=s)throw new b}constructor(t,e){super(),M.add(this),this.pc=t,this.dc=e,this.streams=[],this.pingIntervalId=null,this.pingTime=Date.now()+3e3,this.pc.addEventListener("track",(t=>{this.streams=this.streams.concat(t.streams)})),this.pc.addEventListener("connectionstatechange",(()=>{"disconnected"!==this.pc.connectionState&&"failed"!==this.pc.connectionState||this.close()})),this.dc.onopen=()=>{this.pingIntervalId=setInterval((()=>{this.ping(),Date.now()-this.pingTime>5e3&&this.close()}),1e3)},this.dc.onclose=()=>{null!=this.pingIntervalId&&clearInterval(this.pingIntervalId)},T(this,M,"m",x).call(this,{live:!0,code:200,reason:"OK"}),this.setMessageCallback("ping",(()=>{this.pingTime=Date.now()}))}isReady(){return this.streams.length>0&&"open"===this.dc.readyState}subscribeStatus(t){return this.addEventListener("status",t),()=>{this.removeEventListener("status",t)}}getStream(){return this.streams[0]}sendMessage(t,e){this.dc.send(JSON.stringify({type:t,data:e}))}sendFile(t,e=16384){return new Promise((async s=>{let a=new Uint8Array(await t.arrayBuffer()),n=this.pc.createDataChannel("file",{protocol:"file"});n.addEventListener("message",(t=>{if(0===t.data.length){let t=0;for(;t<a.length;)n.send(a.slice(t,t+e)),t+=e;n.send(new Uint8Array(0))}else n.close(),s(t.data)}))}))}chat(t,e){this.sendMessage("chat",{message:t,history:e})}ttstf(t){this.sendMessage("ttstf",{message:t})}async stf(t,e,s){let a=await this.sendFile(t);return this.sendMessage("stf",{message:s,file_ref:a,format:e}),a}hello(){this.sendMessage("hello",{})}recordStart(){this.sendMessage("record-start",{})}recordEndStt(t){this.sendMessage("record-end-stt",{language:t})}recordEndTranslate(t,e){this.sendMessage("record-end-translate",{src_lang:t,dst_lang:e})}changeSize(t,e){this.sendMessage("change-size",{width:t,height:e})}setTemplate(t,e){this.sendMessage("set-template",{model:t,dress:e})}clearBuffer(){this.sendMessage("clear-buffer",{})}ping(){this.sendMessage("ping",{})}setMessageCallback(t,e){const s=s=>{const a=JSON.parse(s.data);a.type===t&&e(a.data)};return this.dc.addEventListener("message",s),()=>{this.dc.removeEventListener("message",s)}}close(){this.dc.close(),this.pc.close(),T(this,M,"m",x).call(this,{live:!1,code:408,reason:"Request Timeout"})}closeSelf(){this.dc.close(),this.pc.close(),T(this,M,"m",x).call(this,{live:!1,code:200,reason:"OK"})}}M=new WeakSet,x=function(t){this.dispatchEvent(new CustomEvent("status",{detail:t}))};class P{setChatStatus(t){this.micStatusHandler.dispatchEvent(new CustomEvent("status",{detail:{status:t}}))}subscribeChatStatus(t){const e=e=>{t(e.detail.status)};return this.micStatusHandler.addEventListener("status",e),()=>{this.micStatusHandler.removeEventListener("status",e)}}subscribeChatLog(t){const e=e=>{t(e.detail.chatLog)};return this.chatLogHandler.addEventListener("chatLog",e),()=>{this.chatLogHandler.removeEventListener("chatLog",e)}}subscribeStfStartEvent(t){const e=e=>{t(e.detail)};return this.stfStartEventHandler.addEventListener("stfStart",e),()=>{this.stfStartEventHandler.removeEventListener("stfStart",e)}}setSttResultCallback(t){const e=e=>{t(e.detail.text)};return this.sttEventHandler=new EventTarget,this.sttEventHandler.addEventListener("stt",e),()=>{this.sttEventHandler.removeEventListener("stt",e),this.sttEventHandler=null}}constructor(t,e,s){this.sessionId=t,this.stream=e,this.perso=s,this.chatLog=[],this.micStatusHandler=new EventTarget,this.chatLogHandler=new EventTarget,this.stfStartEventHandler=new EventTarget,this.sttEventHandler=null,s.setMessageCallback("stf",(t=>{this.addMessageToChatLog(t.message,!1),this.setChatStatus(3),setTimeout((()=>{this.setChatStatus(0)}),t.duration+3500)})),s.setMessageCallback("stf-start",(t=>{this.stfStartEventHandler.dispatchEvent(new CustomEvent("stfStart",{detail:t}))})),s.setMessageCallback("stt",(t=>{if(null!=this.sttEventHandler)this.setChatStatus(0),this.sttEventHandler.dispatchEvent(new CustomEvent("stt",{detail:t}));else{if(""===t.text)return void this.setChatStatus(0);this.processChat(t.text)}})),s.setMessageCallback("stt-error",(t=>{this.setChatStatus(0)})),s.setMessageCallback("translate-error",(t=>{this.setChatStatus(0)}))}addMessageToChatLog(t,e){this.chatLog=[{text:t,isUser:e,timestamp:new Date},...this.chatLog],this.chatLogHandler.dispatchEvent(new CustomEvent("chatLog",{detail:{chatLog:this.chatLog}}))}getSessionId(){return this.sessionId}getHistory(){return this.chatLog.map((t=>({content:t.text,role:t.isUser?"Human":"AI"}))).reverse()}processChat(t){this.setChatStatus(2),this.perso.chat(t,this.getHistory()),this.addMessageToChatLog(t,!0)}processTTSTF(t){this.setChatStatus(2),this.perso.ttstf(t)}async processSTF(t,e,s){let a=await this.perso.stf(t,e,s);return this.addMessageToChatLog(s,!1),a}intro(){this.setChatStatus(2),this.perso.hello()}startVoiceChat(){return this.setChatStatus(1),this.perso.recordStart()}stopVoiceChat(){return this.setChatStatus(2),this.perso.recordEndStt()}changeSize(t,e){return this.perso.changeSize(t,e)}setMessageCallback(t,e){return this.perso.setMessageCallback(t,e)}setTemplate(t,e){return this.perso.setTemplate(t,e)}clearBuffer(){return this.setChatStatus(0),this.perso.clearBuffer()}setSrc(t){t.srcObject=this.getRemoteStream()}getLocalStream(){return this.stream}getRemoteStream(){return this.perso.getStream()}stopSession(){this.close()}onClose(t){return this.perso.subscribeStatus((e=>{null!=e.detail&&!1===e.detail.live&&t(200===e.detail.code)}))}close(){this.perso.closeSelf()}}const H=k.createSessionId;function D(t,e,s){async function a(t,e){return await I.getLLMs(t,e)}async function n(t,e){return await I.getTTSs(t,e)}async function r(t,e){return await I.getModelStyles(t,e)}async function i(t,e){return await I.getBackgroundImages(t,e)}async function o(t,e){return await I.getPrompts(t,e)}async function c(t,e){return await I.getDocuments(t,e)}return[a,n,r,i,o,c,async function(t,e){const s=await a(t,e),h=await r(t,e),d=await i(t,e);return{llms:s,ttsTypes:await n(t,e),modelStyles:h,backgroundImages:d,prompts:await o(t,e),documents:await c(t,e)}},async function(t,e,s,a,n,r,i,o,c,h,d){return await H(t,e,s,a,n,r,i,o,c,h,d)},async function(t,e,s,a,n){return await(async(t,e,s,a,n)=>{let r=null,i=null;if(n)r=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1}),i=()=>{};else{const t=new AudioContext,e=t.createOscillator();e.frequency.value=0;const s=t.createMediaStreamDestination();e.connect(s),e.start(),r=s.stream,i=()=>{e.stop(),e.disconnect(s)}}const o=await k.create(t,e,r,s,a),c=new P(e,r,o);return c.onClose((t=>{i()})),c})(t,e,s,a,n)},async function(t,e){return await I.getSessionInfo(t,e)}]}return new class extends L{constructor(t){super(),C(this,t,D,null,r,{getLLMs:0,getTTSs:1,getModelStyles:2,getBackgroundImages:3,getPrompts:4,getDocuments:5,getAllSettings:6,createSessionId:7,createSession:8,getSessionInfo:9})}get getLLMs(){return this.$$.ctx[0]}get getTTSs(){return this.$$.ctx[1]}get getModelStyles(){return this.$$.ctx[2]}get getBackgroundImages(){return this.$$.ctx[3]}get getPrompts(){return this.$$.ctx[4]}get getDocuments(){return this.$$.ctx[5]}get getAllSettings(){return this.$$.ctx[6]}get createSessionId(){return this.$$.ctx[7]}get createSession(){return this.$$.ctx[8]}get getSessionInfo(){return this.$$.ctx[9]}}({target:document})}();
